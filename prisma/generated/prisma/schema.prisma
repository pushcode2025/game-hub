// prisma/schema.prisma
// ===============================
// Prisma Schema - Gaming Hub Core
// ===============================

generator client {
  provider   = "prisma-client-js"
  output     = "./generated/prisma"
  engineType = "binary"
}

datasource db {
  provider = "mysql"
}

// ===============================
// Core Tables
// ===============================

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  name      String
  avatar    String?
  bio       String?  @db.Text
  createdAt DateTime @default(now())

  news          News[]
  reviews       Review[]
  mediaItems    MediaItem[]
  mediaLikes    MediaLike[]
  mediaComments MediaComment[]

  @@map("users")
}

model Game {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  description String?   @db.Text
  coverImage  String?
  releaseDate DateTime?
  developer   String?
  publisher   String?
  createdAt   DateTime  @default(now())

  platforms  GamePlatform[]
  news       News[]
  reviews    Review[]
  mediaItems MediaItem[]

  @@map("games")
}

model Platform {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  icon      String?
  createdAt DateTime @default(now())

  games   GamePlatform[]
  reviews ReviewPlatform[]

  @@map("platforms")
}

model GamePlatform {
  id         String @id @default(uuid())
  gameId     String
  platformId String

  game     Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  platform Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@unique([gameId, platformId])
  @@map("game_platforms")
}

// ===============================
// Media Gallery
// ===============================

model MediaItem {
  id          String    @id @default(uuid())
  title       String
  description String?   @db.Text
  type        MediaType // image or video
  url         String // رابط الملف الأساسي
  thumbnail   String? // رابط الصورة المصغرة
  fileSize    Int? // حجم الملف بالبايت
  width       Int? // عرض الصورة/الفيديو
  height      Int? // ارتفاع الصورة/الفيديو
  duration    Int? // مدة الفيديو بالثواني (للفيديو فقط)

  viewsCount    Int @default(0)
  likesCount    Int @default(0)
  commentsCount Int @default(0)

  isFeatured Boolean @default(false)
  isTrending Boolean @default(false)
  published  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  gameId String?
  game   Game?   @relation(fields: [gameId], references: [id], onDelete: SetNull)

  likes    MediaLike[]
  comments MediaComment[]
  tags     MediaTag[]

  @@index([authorId])
  @@index([gameId])
  @@index([type])
  @@index([isTrending])
  @@index([createdAt])
  @@map("media_items")
}

model MediaLike {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  mediaItemId String
  mediaItem   MediaItem @relation(fields: [mediaItemId], references: [id], onDelete: Cascade)

  @@unique([userId, mediaItemId])
  @@index([userId])
  @@index([mediaItemId])
  @@map("media_likes")
}

model MediaComment {
  id        String   @id @default(uuid())
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  mediaItemId String
  mediaItem   MediaItem @relation(fields: [mediaItemId], references: [id], onDelete: Cascade)

  parentId String?
  parent   MediaComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  MediaComment[] @relation("CommentReplies")

  @@index([userId])
  @@index([mediaItemId])
  @@index([parentId])
  @@map("media_comments")
}

model MediaTagItem {
  id   String @id @default(uuid())
  name String
  slug String @unique

  media MediaTag[]

  @@map("media_tag_items")
}

model MediaTag {
  mediaItemId String
  tagId       String

  mediaItem MediaItem    @relation(fields: [mediaItemId], references: [id], onDelete: Cascade)
  tag       MediaTagItem @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([mediaItemId, tagId])
  @@map("media_tags")
}

enum MediaType {
  image
  video
}

// ===============================
// Taxonomy
// ===============================

model Genre {
  id   String @id @default(uuid())
  name String
  slug String @unique

  reviews ReviewGenre[]

  @@map("genres")
}

model Tag {
  id   String @id @default(uuid())
  name String
  slug String @unique

  news NewsTag[]

  @@map("tags")
}

// ===============================
// Content
// ===============================

model News {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  excerpt     String   @db.Text
  contentPath String
  contentType String
  category    String
  isFeatured  Boolean  @default(false)
  published   Boolean  @default(true)
  viewsCount  Int      @default(0)
  likesCount  Int      @default(0)
  createdAt   DateTime @default(now())

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  gameId String?
  game   Game?   @relation(fields: [gameId], references: [id])

  tags NewsTag[]

  @@map("news")
}

model Review {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  excerpt     String   @db.Text
  contentPath String
  contentType String
  rating      Float
  published   Boolean  @default(true)
  viewsCount  Int      @default(0)
  likesCount  Int      @default(0)
  createdAt   DateTime @default(now())

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  gameId String
  game   Game   @relation(fields: [gameId], references: [id])

  genres    ReviewGenre[]
  platforms ReviewPlatform[]

  @@map("reviews")
}

// ===============================
// Pivot Tables
// ===============================

model NewsTag {
  newsId String
  tagId  String

  news News @relation(fields: [newsId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([newsId, tagId])
  @@map("news_tags")
}

model ReviewGenre {
  reviewId String
  genreId  String

  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  genre  Genre  @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([reviewId, genreId])
  @@map("review_genres")
}

model ReviewPlatform {
  reviewId   String
  platformId String

  review   Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  platform Platform @relation(fields: [platformId], references: [id], onDelete: Cascade)

  @@id([reviewId, platformId])
  @@map("review_platforms")
}
